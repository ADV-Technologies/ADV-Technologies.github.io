<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - ADV Technologies</title>

    <link rel="icon" type="image/png" href="/assets/logo.png">
    <link rel="apple-touch-icon" href="/assets/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/styles.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <style>
        /* VISIBLE BY DEFAULT */
        body { background: var(--dark-gray); }
        .navbar { position: fixed; z-index: 1000; }
        
        .admin-panel-container {
            padding-top: 120px; 
            min-height: 100vh;
            position: relative;
            z-index: 10;
            padding-bottom: 5rem;
        }

        /* Glass Panel */
        .glass-panel {
            margin-bottom: 2rem; padding: 2rem;
            border: 1px solid var(--glass-border);
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 20px;
        }
        h3 { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem; margin-bottom: 1.5rem; color: var(--gold); }
        h4 { color: white; margin: 2rem 0 1rem 0; border-left: 3px solid var(--gold); padding-left: 10px; }

        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; color: var(--gold); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 12px; background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border); color: white; border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
        }
        .form-group input:focus { outline: none; border-color: var(--gold); background: rgba(255,255,255,0.1); }
        
        .form-row { display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .form-row .form-group { flex: 1; min-width: 250px; }

        /* Contact Grid */
        .contact-section-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .contact-card {
            background: rgba(0,0,0,0.3); padding: 1.5rem; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08); margin-bottom: 1rem;
        }
        .contact-card h5 { color: white; margin-bottom: 1rem; display: flex; align-items: center; gap: 10px; font-size: 1.1rem; }
        .contact-card h5 i { color: var(--gold); }

        /* Tables */
        .user-list, .project-list { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; color: white; min-width: 700px; }
        th, td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left; }
        th { color: var(--gold); text-transform: uppercase; font-size: 0.8rem; }
        
        .action-btn {
            padding: 8px 16px; background: transparent; border: 1px solid var(--gold); color: var(--gold);
            border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s;
        }
        .action-btn:hover { background: var(--gold); color: black; }
        .delete-btn { border-color: var(--error-red); color: var(--error-red); }
        .delete-btn:hover { background: var(--error-red); color: white; }

        .feedback-inline { margin-left: 15px; font-size: 0.9rem; }
        .feedback-inline.success { color: var(--success-green); }
        .feedback-inline.error { color: var(--error-red); }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .modal-content { background: #111; border: 1px solid var(--gold); padding: 2rem; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 15px; position: relative; }
        
        .loading-overlay { display: none; } /* Hidden by default */
    </style>
</head>
<body>
    
    <canvas id="particles-canvas"></canvas>

    <nav class="navbar" id="navbar">
        <div class="container">
            <div class="logo" onclick="window.location.href='/'">
                <img src="/assets/logo.png" style="height: 50px; border-radius: 12px;">
            </div>
            <div class="user-profile" id="user-profile" style="display: none;">
                <span id="profile-username" style="color: var(--gold); margin-right: 15px; font-weight: 600;">Admin</span>
                <a href="/dashboard/" class="btn-small" style="margin-right: 10px;">Dashboard</a>
                <button class="btn-small" onclick="window.authFunctions.logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="admin-panel-container container section" id="admin-content">
        <div class="dashboard-header">
            <h1><i class="fas fa-cogs"></i> Admin Panel</h1>
        </div>

        <section class="glass-panel">
            <h3><i class="fas fa-pen-fancy"></i> Site Content</h3>
            <form id="content-form">
                <h4>Hero Section</h4>
                <div class="form-row">
                    <div class="form-group"><label>Title Line 1</label><input type="text" id="hero_text_1" placeholder="Welcome..."></div>
                    <div class="form-group"><label>Title Line 2</label><input type="text" id="hero_text_2" placeholder="Innovation..."></div>
                </div>
                <div class="form-group"><label>Subtitle</label><input type="text" id="hero_subtitle" placeholder="Subtext..."></div>

                <h4>About Me</h4>
                <div class="form-group"><label>Title</label><input type="text" id="about_me_title"></div>
                <div class="form-group"><label>Content</label><textarea id="about_me_content"></textarea></div>

                <h4>About ADV</h4>
                <div class="form-group"><label>Title</label><input type="text" id="about_adv_title"></div>
                <div class="form-group"><label>Content</label><textarea id="about_adv_content"></textarea></div>

                <button type="submit" class="action-btn" id="save-content-btn">Save Content</button>
                <span id="content-feedback" class="feedback-inline"></span>
            </form>
        </section>

        <section class="glass-panel">
            <h3><i class="fas fa-address-book"></i> Contact Info</h3>
            <form id="contact-form">
                <div class="contact-section-grid">
                    <div class="contact-column">
                        <h4>Professional</h4>
                        <div class="contact-card">
                            <h5><i class="fas fa-envelope"></i> Email</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-email_professional"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-email_professional"></div>
                        </div>
                        <div class="contact-card">
                            <h5><i class="fab fa-github"></i> GitHub</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-github_professional"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-github_professional"></div>
                        </div>
                    </div>

                    <div class="contact-column">
                        <h4>Personal</h4>
                        <div class="contact-card">
                            <h5><i class="fas fa-envelope"></i> Email</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-email_personal"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-email_personal"></div>
                        </div>
                        <div class="contact-card">
                            <h5><i class="fab fa-github"></i> GitHub</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-github_personal"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-github_personal"></div>
                        </div>
                        <div class="contact-card">
                            <h5><i class="fab fa-facebook"></i> Facebook</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-facebook"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-facebook"></div>
                        </div>
                        <div class="contact-card">
                            <h5><i class="fab fa-instagram"></i> Instagram</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-instagram"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-instagram"></div>
                        </div>
                        <div class="contact-card">
                            <h5><i class="fab fa-x-twitter"></i> X (Twitter)</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-x"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-x"></div>
                        </div>
                        <div class="contact-card">
                            <h5><i class="fab fa-linkedin"></i> LinkedIn</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-linkedin"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-linkedin"></div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="action-btn" id="save-contact-btn">Save Contacts</button>
                <span id="contact-feedback" class="feedback-inline"></span>
            </form>
        </section>

        <section class="glass-panel">
            <h3><i class="fas fa-project-diagram"></i> Projects</h3>
            <div class="project-list" style="margin-bottom: 2rem;">
                 <table>
                    <thead><tr><th>Order</th><th>Name</th><th>Status</th><th>Edit</th></tr></thead>
                    <tbody id="project-list-body">
                        <tr><td colspan="4">Loading projects...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <h4>Add New Project</h4>
            <form id="add-project-form">
                <div class="form-row">
                    <div class="form-group"><label>Name</label><input type="text" id="p-name" required></div>
                    <div class="form-group"><label>Slug</label><input type="text" id="p-slug" required></div>
                </div>
                <div class="form-group"><label>Description</label><textarea id="p-desc" required></textarea></div>
                <div class="form-row">
                    <div class="form-group"><label>URL</label><input type="url" id="p-url"></div>
                    <div class="form-group"><label>Access</label>
                        <select id="p-access"><option value="public">Public</option><option value="member">Member</option><option value="admin">Admin</option></select>
                    </div>
                </div>
                <button type="submit" class="action-btn" id="add-project-btn">Add Project</button>
                <span id="project-feedback" class="feedback-inline"></span>
            </form>
        </section>

        <section class="glass-panel">
            <h3><i class="fas fa-users-cog"></i> Users</h3>
            <div class="user-list">
                <table>
                    <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="user-list-body">
                        <tr><td colspan="5">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="glass-panel">
            <h3><i class="fas fa-palette"></i> Theme</h3>
            <form id="theme-form">
                <div class="form-row">
                    <div class="form-group"><label>Primary Color</label><input type="color" id="primary_color" style="height:45px;"></div>
                    <div class="form-group"><label>Opacity</label><input type="number" id="glassmorphism_opacity" step="0.01"></div>
                </div>
                <button type="submit" class="action-btn" id="save-theme-btn">Update Theme</button>
                <span id="theme-feedback" class="feedback-inline"></span>
            </form>
        </section>
    </div>

    <div id="edit-project-modal" class="modal">
         <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                <h3>Edit Project</h3>
                <span style="cursor:pointer;font-size:1.5rem;" onclick="window.commonFunctions.closeModal('edit-project')">&times;</span>
            </div>
            <form id="edit-project-form">
                <input type="hidden" id="ep-id">
                <div class="form-row">
                    <div class="form-group"><label>Name</label><input type="text" id="ep-name" required></div>
                    <div class="form-group"><label>Slug</label><input type="text" id="ep-slug" required></div>
                </div>
                <div class="form-group"><label>Description</label><textarea id="ep-desc" required></textarea></div>
                <div class="form-group"><label>URL</label><input type="url" id="ep-url"></div>
                <div class="form-row">
                    <div class="form-group"><label>Status</label>
                        <select id="ep-status">
                            <option value="active">Active</option>
                            <option value="coming_soon">Coming Soon</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="deprecated">Deprecated</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Access</label>
                        <select id="ep-access"><option value="public">Public</option><option value="member">Member</option><option value="admin">Admin</option></select>
                    </div>
                </div>
                <div class="form-group"><label>Order</label><input type="number" id="ep-order"></div>
                <div style="display:flex;justify-content:space-between;margin-top:2rem;">
                    <button type="submit" class="action-btn">Update</button>
                    <button type="button" class="action-btn delete-btn" id="delete-project-btn">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        window.SUPABASE_CONFIG = {
            url: 'https://xblihylcpepkuriatqtg.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhibGloeWxjcGVwa3VyaWF0cXRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMDEwNDIsImV4cCI6MjA3NzY3NzA0Mn0.Ka_dkjTcPmzfhTBmCrUNrfxU_G8UncebUwM5h-Wlhns'
        };
    </script>
    <script src="/js/config.js"></script>
    <script src="/js/common.js"></script>
    <script src="/js/particles.js"></script>
    <script src="/js/auth.js"></script>

    <script>
        const feedback = (id, msg, type) => {
            const el = document.getElementById(id);
            if(el) { el.textContent = msg; el.className = `feedback-inline ${type}`; setTimeout(() => el.textContent='', 4000); }
        };

        const safeSetValue = (id, value) => {
            const el = document.getElementById(id);
            if(el) el.value = value;
        };

        // --- SAFE INIT WITH ROUTE GUARD ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof window.initParticles === 'function') window.initParticles();
            
            try {
                if (!window.supabaseClient) return;

                // 1. Check Login
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) { window.location.href = '/login/'; return; }

                // 2. Check Role (Strict)
                const { data: profile } = await window.supabaseClient.from('user_profiles').select('role').eq('id', session.user.id).single();
                if (!profile || profile.role !== 'admin') {
                    alert("Access Denied: Admins Only");
                    window.location.href = '/dashboard/';
                    return;
                }

                // 3. User is Admin -> Show UI & Load Data
                document.getElementById('user-profile').style.display = 'flex';
                
                // Safe parallel loading
                loadContent();
                loadContact();
                loadProjects();
                loadUsers();
                loadTheme();

            } catch (err) {
                console.error("Init Failed:", err);
            }
        });

        // --- 1. CONTENT ---
        async function loadContent() {
            try {
                const { data: settings } = await window.supabaseClient.from('website_settings').select('*');
                if(settings) {
                    const map = {'hero_text_1':'hero_text_1', 'hero_text_2':'hero_text_2', 'hero_subtitle':'hero_subtitle'};
                    settings.forEach(s => { if(map[s.setting_key]) safeSetValue(map[s.setting_key], s.setting_value); });
                }
                const { data: pages } = await window.supabaseClient.from('pages_content').select('*');
                if(pages) {
                    const me = pages.find(p => p.page_key === 'about_me');
                    const adv = pages.find(p => p.page_key === 'about_adv');
                    if(me) { safeSetValue('about_me_title', me.title); safeSetValue('about_me_content', me.content); }
                    if(adv) { safeSetValue('about_adv_title', adv.title); safeSetValue('about_adv_content', adv.content); }
                }
            } catch(e) { console.error(e); }
        }

        document.getElementById('content-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-content-btn'); btn.disabled=true;
            try {
                const uid = window.authFunctions.getCurrentUser().id;
                const upsertSet = async (k, v) => window.supabaseClient.from('website_settings').upsert({setting_key: k, setting_value: v, updated_by: uid}, {onConflict: 'setting_key'});
                const upsertPage = async (k, t, c) => window.supabaseClient.from('pages_content').upsert({page_key: k, title: t, content: c, updated_by: uid}, {onConflict: 'page_key'});

                await upsertSet('hero_text_1', document.getElementById('hero_text_1').value);
                await upsertSet('hero_text_2', document.getElementById('hero_text_2').value);
                await upsertSet('hero_subtitle', document.getElementById('hero_subtitle').value);
                await upsertPage('about_me', document.getElementById('about_me_title').value, document.getElementById('about_me_content').value);
                await upsertPage('about_adv', document.getElementById('about_adv_title').value, document.getElementById('about_adv_content').value);
                feedback('content-feedback', 'Saved!', 'success');
            } catch(e) { feedback('content-feedback', 'Error', 'error'); }
            btn.disabled=false;
        });

        // --- 2. CONTACT ---
        async function loadContact() {
            try {
                const { data } = await window.supabaseClient.from('contact_info').select('*');
                if(data) {
                    data.forEach(c => {
                        safeSetValue(`url-${c.platform}`, c.url);
                        safeSetValue(`txt-${c.platform}`, c.display_text || '');
                    });
                }
            } catch(e) { console.error(e); }
        }

        document.getElementById('contact-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-contact-btn'); btn.disabled=true;
            try {
                const uid = window.authFunctions.getCurrentUser().id;
                const platforms = ['email_professional', 'github_professional', 'email_personal', 'github_personal', 'facebook', 'instagram', 'x', 'linkedin'];
                for(const p of platforms) {
                    const u = document.getElementById(`url-${p}`).value;
                    const t = document.getElementById(`txt-${p}`).value;
                    if(u || t) await window.supabaseClient.from('contact_info').upsert({platform: p, url: u, display_text: t, updated_by: uid}, {onConflict: 'platform'});
                }
                feedback('contact-feedback', 'Saved!', 'success');
            } catch(e) { feedback('contact-feedback', 'Error', 'error'); }
            btn.disabled=false;
        });

        // --- 3. PROJECTS ---
        async function loadProjects() {
            try {
                const { data } = await window.supabaseClient.from('projects').select('*').order('display_order');
                const tbody = document.getElementById('project-list-body');
                tbody.innerHTML = '';
                if(data && data.length) {
                    data.forEach(p => {
                        tbody.innerHTML += `<tr><td>${p.display_order}</td><td>${p.name}</td><td>${p.status}</td><td><button class="action-btn" onclick="editProject('${p.id}')">Edit</button></td></tr>`;
                    });
                } else { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">No projects.</td></tr>'; }
            } catch(e) { console.error(e); }
        }

        window.editProject = async (id) => {
            const { data } = await window.supabaseClient.from('projects').select('*').eq('id', id).single();
            if(data) {
                safeSetValue('ep-id', data.id);
                safeSetValue('ep-name', data.name);
                safeSetValue('ep-slug', data.slug);
                safeSetValue('ep-desc', data.description);
                safeSetValue('ep-url', data.url);
                safeSetValue('ep-status', data.status);
                safeSetValue('ep-access', data.access_level);
                safeSetValue('ep-order', data.display_order);
                document.getElementById('delete-project-btn').onclick = () => deleteProject(data.id, data.name);
                window.commonFunctions.openModal('edit-project');
            }
        };

        document.getElementById('add-project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const { data: max } = await window.supabaseClient.from('projects').select('display_order').neq('slug', 'coming-soon').order('display_order', {ascending:false}).limit(1);
                const order = (max && max.length) ? max[0].display_order + 1 : 1;
                const p = {
                    name: document.getElementById('p-name').value,
                    slug: document.getElementById('p-slug').value,
                    description: document.getElementById('p-desc').value,
                    url: document.getElementById('p-url').value,
                    access_level: document.getElementById('p-access').value,
                    display_order: order,
                    status: 'coming_soon',
                    created_by: window.authFunctions.getCurrentUser().id
                };
                const { error } = await window.supabaseClient.from('projects').insert([p]);
                if(!error) {
                    await window.supabaseClient.from('projects').update({display_order: order+1}).eq('slug', 'coming-soon');
                    feedback('project-feedback', 'Added!', 'success'); document.getElementById('add-project-form').reset(); loadProjects();
                }
            } catch(e) { feedback('project-feedback', 'Error', 'error'); }
        });

        document.getElementById('edit-project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('ep-id').value;
            const p = {
                name: document.getElementById('ep-name').value,
                slug: document.getElementById('ep-slug').value,
                description: document.getElementById('ep-desc').value,
                url: document.getElementById('ep-url').value,
                status: document.getElementById('ep-status').value,
                access_level: document.getElementById('ep-access').value,
                display_order: document.getElementById('ep-order').value
            };
            const { error } = await window.supabaseClient.from('projects').update(p).eq('id', id);
            if(!error) { window.commonFunctions.closeModal('edit-project'); loadProjects(); }
        });

        async function deleteProject(id, name) {
            if(confirm(`Delete ${name}?`)) {
                await window.supabaseClient.from('projects').delete().eq('id', id);
                window.commonFunctions.closeModal('edit-project'); loadProjects();
            }
        }

        // --- 4. USERS (SIMPLE LOAD) ---
        async function loadUsers() {
            try {
                // Fetch all users (Allowed by Step 1 SQL)
                const { data: users } = await window.supabaseClient.from('user_profiles').select('id, username, email, role, is_banned').order('username');
                const tbody = document.getElementById('user-list-body');
                tbody.innerHTML = '';
                
                if(users && users.length > 0) {
                    users.forEach(u => {
                        const isMe = u.id === window.authFunctions.getCurrentUser().id;
                        tbody.innerHTML += `<tr>
                            <td>${u.username} ${isMe?'(You)':''}</td>
                            <td>${u.email}</td>
                            <td>
                                <select id="role-${u.id}" ${isMe?'disabled':''}>
                                    <option value="user" ${u.role==='user'?'selected':''}>User</option>
                                    <option value="member" ${u.role==='member'?'selected':''}>Member</option>
                                    <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
                                </select>
                                <button class="action-btn" onclick="changeRole('${u.id}')" ${isMe?'disabled':''}>Save</button>
                            </td>
                            <td>${u.is_banned ? '<span style="color:var(--error-red)">Banned</span>':'<span style="color:var(--success-green)">Active</span>'}</td>
                            <td>
                                ${u.is_banned 
                                    ? `<button class="action-btn unban-btn" onclick="toggleBan('${u.id}', false)">Unban</button>`
                                    : `<button class="action-btn ban-btn" onclick="toggleBan('${u.id}', true)" ${isMe?'disabled':''}>Ban</button>`
                                }
                            </td>
                        </tr>`;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No users found.</td></tr>';
                }
            } catch(e) { console.error(e); }
        }

        window.changeRole = async (id) => {
            const r = document.getElementById(`role-${id}`).value;
            if(confirm(`Set role to ${r}?`)) {
                try { await window.supabaseClient.rpc('change_user_role', {target_user_id: id, new_role: r}); loadUsers(); } catch(e) { alert("Error"); }
            }
        };

        window.toggleBan = async (id, ban) => {
            try {
                if(ban) {
                    const r = prompt("Reason?"); if(!r) return;
                    await window.supabaseClient.rpc('ban_user', {target_user_id: id, ban_reason_text: r});
                } else {
                    await window.supabaseClient.rpc('unban_user', {target_user_id: id});
                }
                loadUsers();
            } catch(e) { alert("Error"); }
        };

        // --- 5. THEME ---
        async function loadTheme() {
            try {
                const { data } = await window.supabaseClient.from('website_settings').select('*');
                if(data) {
                    const c = data.find(s => s.setting_key === 'primary_color');
                    const o = data.find(s => s.setting_key === 'glassmorphism_opacity');
                    if(c) safeSetValue('primary_color', c.setting_value);
                    if(o) safeSetValue('glassmorphism_opacity', o.setting_value);
                }
            } catch(e) {}
        }

        document.getElementById('theme-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-theme-btn'); btn.disabled=true;
            const uid = window.authFunctions.getCurrentUser().id;
            try {
                await window.supabaseClient.from('website_settings').upsert({setting_key: 'primary_color', setting_value: document.getElementById('primary_color').value, updated_by: uid}, {onConflict: 'setting_key'});
                await window.supabaseClient.from('website_settings').upsert({setting_key: 'glassmorphism_opacity', setting_value: document.getElementById('glassmorphism_opacity').value, updated_by: uid}, {onConflict: 'setting_key'});
                if(window.commonFunctions.applyWebsiteSettings) window.commonFunctions.applyWebsiteSettings();
                feedback('theme-feedback', 'Updated!', 'success');
            } catch(e) { feedback('theme-feedback', 'Error', 'error'); }
            btn.disabled=false;
        });
    </script>
</body>
</html>
