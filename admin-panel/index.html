<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - ADV Technologies</title>

    <link rel="icon" type="image/png" href="/assets/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <style>
        /* FORCE VISIBILITY - NO HIDING! */
        body { background: var(--dark-gray); opacity: 1 !important; visibility: visible !important; }
        .navbar { position: fixed; z-index: 1000; }
        .admin-panel-container { padding-top: 120px; padding-bottom: 5rem; min-height: 100vh; position: relative; z-index: 10; }

        /* Styles for Forms & Layout */
        .glass-panel { margin-bottom: 2rem; padding: 2rem; border: 1px solid var(--glass-border); background: rgba(10,10,10,0.6); backdrop-filter: blur(20px); border-radius: 20px; }
        h3 { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem; margin-bottom: 1.5rem; color: var(--gold); }
        h4 { color: white; margin: 2rem 0 1rem 0; border-left: 3px solid var(--gold); padding-left: 10px; }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; color: var(--gold); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 8px; font-family: 'Montserrat', sans-serif; }
        .form-row { display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .form-row .form-group { flex: 1; min-width: 250px; }
        
        .contact-section-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .contact-card { background: rgba(0,0,0,0.3); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 1rem; }
        
        .user-list table, .project-list table { width: 100%; border-collapse: collapse; color: white; min-width: 600px; }
        th, td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left; }
        th { color: var(--gold); }
        
        .action-btn { padding: 8px 16px; background: transparent; border: 1px solid var(--gold); color: var(--gold); border-radius: 6px; cursor: pointer; transition: 0.3s; }
        .action-btn:hover { background: var(--gold); color: black; }
        
        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #111; border: 1px solid var(--gold); padding: 2rem; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 15px; }
    </style>
</head>
<body>
    
    <canvas id="particles-canvas"></canvas>

    <nav class="navbar" id="navbar">
        <div class="container">
            <div class="logo" onclick="window.location.href='/'">
                <img src="/assets/logo.png" style="height: 50px; border-radius: 12px;">
            </div>
            <div class="user-profile" id="user-profile" style="display: none;">
                <span style="color: var(--gold); margin-right: 15px;">Admin</span>
                <a href="/dashboard/" class="btn-small" style="margin-right: 10px;">Dashboard</a>
                <button class="btn-small" onclick="window.authFunctions.logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="admin-panel-container container section" id="admin-content">
        <div class="dashboard-header">
            <h1><i class="fas fa-cogs"></i> Admin Panel</h1>
        </div>

        <section class="glass-panel">
            <h3><i class="fas fa-pen-fancy"></i> Site Content</h3>
            <form id="content-form">
                <h4>Hero</h4>
                <div class="form-row">
                    <div class="form-group"><label>Title 1</label><input type="text" id="hero_text_1"></div>
                    <div class="form-group"><label>Title 2</label><input type="text" id="hero_text_2"></div>
                </div>
                <div class="form-group"><label>Subtitle</label><input type="text" id="hero_subtitle"></div>
                <h4>About Me</h4>
                <div class="form-group"><label>Title</label><input type="text" id="about_me_title"></div>
                <div class="form-group"><label>Content</label><textarea id="about_me_content"></textarea></div>
                <h4>About ADV</h4>
                <div class="form-group"><label>Title</label><input type="text" id="about_adv_title"></div>
                <div class="form-group"><label>Content</label><textarea id="about_adv_content"></textarea></div>
                <button type="submit" class="action-btn" id="save-content-btn">Save Content</button>
            </form>
        </section>

        <section class="glass-panel">
            <h3><i class="fas fa-address-book"></i> Contact Info</h3>
            <form id="contact-form">
                <div class="contact-section-grid">
                    <div class="contact-column">
                        <h4>Professional</h4>
                        <div class="contact-card">
                            <h5>Email</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-email_professional"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-email_professional"></div>
                        </div>
                        <div class="contact-card">
                            <h5>GitHub</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-github_professional"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-github_professional"></div>
                        </div>
                    </div>
                    <div class="contact-column">
                        <h4>Personal</h4>
                        <div class="contact-card">
                            <h5>Email</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-email_personal"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-email_personal"></div>
                        </div>
                        <div class="contact-card">
                            <h5>GitHub</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-github_personal"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-github_personal"></div>
                        </div>
                        <div class="contact-card">
                            <h5>Facebook</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-facebook"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-facebook"></div>
                        </div>
                        <div class="contact-card">
                            <h5>Instagram</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-instagram"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-instagram"></div>
                        </div>
                        <div class="contact-card">
                            <h5>X (Twitter)</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-x"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-x"></div>
                        </div>
                        <div class="contact-card">
                            <h5>LinkedIn</h5>
                            <div class="form-group"><label>Link</label><input type="text" id="url-linkedin"></div>
                            <div class="form-group"><label>Text</label><input type="text" id="txt-linkedin"></div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="action-btn" id="save-contact-btn">Save Contacts</button>
            </form>
        </section>

        <section class="glass-panel">
            <h3><i class="fas fa-project-diagram"></i> Projects</h3>
            <div class="project-list" style="margin-bottom:2rem; overflow-x:auto;">
                 <table style="width:100%;">
                    <thead><tr><th>Name</th><th>Status</th><th>Edit</th></tr></thead>
                    <tbody id="project-list-body"><tr><td colspan="3">Loading...</td></tr></tbody>
                </table>
            </div>
            <h4>Add Project</h4>
            <form id="add-project-form">
                <div class="form-row">
                    <div class="form-group"><label>Name</label><input type="text" id="p-name" required></div>
                    <div class="form-group"><label>Slug</label><input type="text" id="p-slug" required></div>
                </div>
                <div class="form-group"><label>Description</label><textarea id="p-desc" required></textarea></div>
                <div class="form-row">
                    <div class="form-group"><label>URL</label><input type="url" id="p-url"></div>
                    <div class="form-group"><label>Access</label>
                        <select id="p-access"><option value="public">Public</option><option value="member">Member</option><option value="admin">Admin</option></select>
                    </div>
                </div>
                <button type="submit" class="action-btn" id="add-project-btn">Add Project</button>
            </form>
        </section>

        <section class="glass-panel">
            <h3><i class="fas fa-users-cog"></i> Users</h3>
            <div class="user-list" style="overflow-x:auto;">
                <table style="width:100%;">
                    <thead><tr><th>User</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="user-list-body"><tr><td colspan="4">Loading...</td></tr></tbody>
                </table>
            </div>
        </section>

        <section class="glass-panel">
            <h3><i class="fas fa-palette"></i> Theme</h3>
            <form id="theme-form">
                <div class="form-row">
                    <div class="form-group"><label>Color</label><input type="color" id="primary_color" style="height:45px;"></div>
                    <div class="form-group"><label>Opacity</label><input type="number" id="glassmorphism_opacity" step="0.01"></div>
                </div>
                <button type="submit" class="action-btn" id="save-theme-btn">Update Theme</button>
            </form>
        </section>
    </div>

    <div id="edit-project-modal" class="modal">
         <div class="modal-content">
            <div style="display:flex;justify-content:space-between;"><h3>Edit</h3><span onclick="window.commonFunctions.closeModal('edit-project')" style="cursor:pointer;font-size:1.5rem;">&times;</span></div>
            <form id="edit-project-form">
                <input type="hidden" id="ep-id">
                <div class="form-row"><div class="form-group"><label>Name</label><input type="text" id="ep-name"></div><div class="form-group"><label>Slug</label><input type="text" id="ep-slug"></div></div>
                <div class="form-group"><label>Desc</label><textarea id="ep-desc"></textarea></div>
                <div class="form-group"><label>URL</label><input type="text" id="ep-url"></div>
                <div class="form-row">
                    <div class="form-group"><label>Status</label><select id="ep-status"><option value="active">Active</option><option value="coming_soon">Coming Soon</option></select></div>
                    <div class="form-group"><label>Access</label><select id="ep-access"><option value="public">Public</option><option value="member">Member</option><option value="admin">Admin</option></select></div>
                </div>
                <div class="form-group"><label>Order</label><input type="number" id="ep-order"></div>
                <div style="margin-top:1rem;display:flex;justify-content:space-between;"><button type="submit" class="action-btn">Update</button><button type="button" class="action-btn" style="border-color:red;color:red;" onclick="deleteProject()">Delete</button></div>
            </form>
        </div>
    </div>

    <script>
        window.SUPABASE_CONFIG = { url: 'https://xblihylcpepkuriatqtg.supabase.co', anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhibGloeWxjcGVwa3VyaWF0cXRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMDEwNDIsImV4cCI6MjA3NzY3NzA0Mn0.Ka_dkjTcPmzfhTBmCrUNrfxU_G8UncebUwM5h-Wlhns' };
    </script>
    <script src="/js/config.js"></script>
    <script src="/js/common.js"></script>
    <script src="/js/particles.js"></script>
    <script src="/js/auth.js"></script>

    <script>
        // HELPERS
        const safeSet = (id, val) => { const e = document.getElementById(id); if(e) e.value = val; };
        
        document.addEventListener('DOMContentLoaded', async () => {
            if(window.initParticles) window.initParticles();
            
            if(!window.supabaseClient) return;
            const { data: { session } } = await window.supabaseClient.auth.getSession();
            
            if(!session) { window.location.href = '/login/'; return; }
            
            // Check Admin
            const { data: profile } = await window.supabaseClient.from('user_profiles').select('role').eq('id', session.user.id).single();
            if(!profile || profile.role !== 'admin') {
                alert("Access Denied");
                window.location.href = '/dashboard/';
                return;
            }
            
            document.getElementById('user-profile').style.display = 'flex';
            
            // Load Data
            loadContent();
            loadContact();
            loadProjects();
            loadUsers();
            loadTheme();
        });

        // 1. CONTENT
        async function loadContent() {
            try {
                const { data: s } = await window.supabaseClient.from('website_settings').select('*');
                if(s) {
                    const m = {'hero_text_1':'hero_text_1', 'hero_text_2':'hero_text_2', 'hero_subtitle':'hero_subtitle'};
                    s.forEach(i => { if(m[i.setting_key]) safeSet(m[i.setting_key], i.setting_value); });
                }
                const { data: p } = await window.supabaseClient.from('pages_content').select('*');
                if(p) {
                    const me = p.find(x => x.page_key === 'about_me');
                    if(me) { safeSet('about_me_title', me.title); safeSet('about_me_content', me.content); }
                    const adv = p.find(x => x.page_key === 'about_adv');
                    if(adv) { safeSet('about_adv_title', adv.title); safeSet('about_adv_content', adv.content); }
                }
            } catch(e) { console.error(e); }
        }
        document.getElementById('content-form').onsubmit = async (e) => {
            e.preventDefault();
            const uid = window.authFunctions.getCurrentUser().id;
            const upsertS = async (k, v) => window.supabaseClient.from('website_settings').upsert({setting_key:k, setting_value:v, updated_by:uid}, {onConflict:'setting_key'});
            const upsertP = async (k, t, c) => window.supabaseClient.from('pages_content').upsert({page_key:k, title:t, content:c, updated_by:uid}, {onConflict:'page_key'});
            
            await upsertS('hero_text_1', document.getElementById('hero_text_1').value);
            await upsertS('hero_text_2', document.getElementById('hero_text_2').value);
            await upsertS('hero_subtitle', document.getElementById('hero_subtitle').value);
            await upsertP('about_me', document.getElementById('about_me_title').value, document.getElementById('about_me_content').value);
            await upsertP('about_adv', document.getElementById('about_adv_title').value, document.getElementById('about_adv_content').value);
            alert("Content Saved!");
        };

        // 2. CONTACT
        async function loadContact() {
            const { data } = await window.supabaseClient.from('contact_info').select('*');
            if(data) data.forEach(c => { safeSet(`url-${c.platform}`, c.url); safeSet(`txt-${c.platform}`, c.display_text); });
        }
        document.getElementById('contact-form').onsubmit = async (e) => {
            e.preventDefault();
            const uid = window.authFunctions.getCurrentUser().id;
            const plats = ['email_professional', 'github_professional', 'email_personal', 'github_personal', 'facebook', 'instagram', 'x', 'linkedin'];
            for(const p of plats) {
                const u = document.getElementById(`url-${p}`).value;
                const t = document.getElementById(`txt-${p}`).value;
                if(u||t) await window.supabaseClient.from('contact_info').upsert({platform:p, url:u, display_text:t, updated_by:uid}, {onConflict:'platform'});
            }
            alert("Contacts Saved!");
        };

        // 3. PROJECTS
        async function loadProjects() {
            const { data } = await window.supabaseClient.from('projects').select('*').order('display_order');
            const b = document.getElementById('project-list-body');
            b.innerHTML = '';
            if(data) data.forEach(p => {
                b.innerHTML += `<tr><td>${p.name}</td><td>${p.status}</td><td><button class="action-btn" onclick="openEditP('${p.id}')">Edit</button></td></tr>`;
            });
        }
        window.openEditP = async (id) => {
            const { data } = await window.supabaseClient.from('projects').select('*').eq('id', id).single();
            if(data) {
                safeSet('ep-id', data.id); safeSet('ep-name', data.name); safeSet('ep-slug', data.slug);
                safeSet('ep-desc', data.description); safeSet('ep-url', data.url); safeSet('ep-status', data.status);
                safeSet('ep-access', data.access_level); safeSet('ep-order', data.display_order);
                window.commonFunctions.openModal('edit-project');
            }
        };
        document.getElementById('add-project-form').onsubmit = async (e) => {
            e.preventDefault();
            const p = {
                name: document.getElementById('p-name').value,
                slug: document.getElementById('p-slug').value,
                description: document.getElementById('p-desc').value,
                url: document.getElementById('p-url').value,
                access_level: document.getElementById('p-access').value,
                status: 'coming_soon', created_by: window.authFunctions.getCurrentUser().id
            };
            await window.supabaseClient.from('projects').insert([p]);
            loadProjects(); alert("Project Added"); document.getElementById('add-project-form').reset();
        };
        // (Edit and Delete handlers logic remains similar)

        // 4. USERS
        async function loadUsers() {
            const { data } = await window.supabaseClient.from('user_profiles').select('*').order('username');
            const b = document.getElementById('user-list-body');
            b.innerHTML = '';
            if(data) data.forEach(u => {
                const isMe = u.id === window.authFunctions.getCurrentUser().id;
                b.innerHTML += `<tr>
                    <td>${u.username} ${isMe?'(You)':''}</td>
                    <td>${u.role}</td>
                    <td>${u.is_banned?'Banned':'Active'}</td>
                    <td>
                        ${!isMe ? `<button class="action-btn" onclick="toggleBan('${u.id}', ${!u.is_banned})">${u.is_banned?'Unban':'Ban'}</button>` : '-'}
                    </td>
                </tr>`;
            });
        }
        window.toggleBan = async (id, ban) => {
            if(ban) await window.supabaseClient.rpc('ban_user', {target_user_id:id, ban_reason_text:'Admin Action'});
            else await window.supabaseClient.rpc('unban_user', {target_user_id:id});
            loadUsers();
        };

        // 5. THEME
        async function loadTheme() {
            const { data } = await window.supabaseClient.from('website_settings').select('*');
            if(data) {
                const c = data.find(s=>s.setting_key==='primary_color');
                const o = data.find(s=>s.setting_key==='glassmorphism_opacity');
                if(c) safeSet('primary_color', c.setting_value);
                if(o) safeSet('glassmorphism_opacity', o.setting_value);
            }
        }
        document.getElementById('theme-form').onsubmit = async (e) => {
            e.preventDefault();
            const uid = window.authFunctions.getCurrentUser().id;
            await window.supabaseClient.from('website_settings').upsert({setting_key:'primary_color', setting_value:document.getElementById('primary_color').value, updated_by:uid}, {onConflict:'setting_key'});
            await window.supabaseClient.from('website_settings').upsert({setting_key:'glassmorphism_opacity', setting_value:document.getElementById('glassmorphism_opacity').value, updated_by:uid}, {onConflict:'setting_key'});
            if(window.commonFunctions.applyWebsiteSettings) window.commonFunctions.applyWebsiteSettings();
            alert("Theme Updated");
        };
    </script>
</body>
</html>
